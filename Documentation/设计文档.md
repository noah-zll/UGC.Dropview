# Unity 下拉内容/下拉选择组件（UGC.Dropview）设计文档

## 1. 概述

### 1.1 项目简介
UGC.Dropview 是一个可自定义“下拉内容/下拉选择”的 Unity UI 组件包，支持**选择模式**（单选/多选）与**非选择模式**（仅作为内容显示开关）。下拉内容可来自预制体/模板，也可通过代码动态创建。组件以 UGUI 为首选实现，并预留 UI Toolkit 适配点。

目标是在原生 `Dropdown`/`TMP_Dropdown` 能力之外，提供更灵活的内容、交互、动画与扩展能力，适配表单选项、过滤条件、上下文菜单、日期/颜色选择器等场景。

### 1.2 兼容与参考
- 兼容 Unity 2021.3+，依赖 `com.unity.ugui`
- 包命名与程序集风格参考现有工程（如 UGC.CollapseScrollView 的 `package.json` 与 `asmdef`）
- UI 组件识别与事件绑定风格可参考现有工具：
  - UGF.GameFramework.UI/Editor/Tools/UIDesignerContextMenu.cs:127
  - UGF.GameFramework.UI/Runtime/Core/UIExtensions.cs:210

## 2. 核心特性
- 内容来源灵活：预制体、VisualTreeAsset（可选）、代码构建器
- 选择模式：`None`（非选择）/`Single`（单选）/`Multiple`（多选）
- 锚定与布局：相对触发器或目标 `RectTransform` 锚定，自动位置翻转（上/下/左/右）
- 交互关闭：外部点击、ESC、失焦、二次点击触发器、可配置自动关闭策略
- 动画：展开/收起高度/透明度/缩放动画，曲线与时长可配置
- 列表支持：`ScrollRect` 容器；支持滚动与（可选）虚拟化
- 对象池：项/内容可选复用，减少频繁实例化销毁
- 事件：打开/关闭生命周期、项点击、选择变更、布局变化
- 可主题化：样式接口、皮肤/配色、图标与字体适配（可选 TextMeshPro）
- 编辑器支持：自定义 Inspector、自动构建基础层级、调试面板

## 3. 包结构与元数据建议

### 3.1 目录结构
```
UGC.Dropview/
├── Runtime/
│   ├── Dropview.cs
│   ├── Core/
│   │   ├── SelectionController.cs
│   │   ├── ItemListController.cs
│   │   ├── AnimatorController.cs
│   │   ├── LayoutController.cs
│   │   ├── ContentHost.cs
│   │   ├── ContentBuilder.cs
│   │   ├── EventBus.cs
│   ├── Interfaces/
│   │   ├── IDropItemRenderer.cs
│   │   ├── IDropviewContentBuilder.cs
│   │   ├── ISelectionPolicy.cs
│   ├── Models/
│   │   ├── DropItemData.cs
│   │   ├── DropviewData.cs
│   │   ├── AnimationConfig.cs
│   │   ├── PositioningConfig.cs
│   ├── Pool/
│   │   ├── ItemPool.cs
│   ├── UGC.Dropview.asmdef
├── Editor/
│   ├── DropviewEditor.cs
│   ├── UGC.Dropview.Editor.asmdef
├── Samples~/
│   ├── BasicDropviewDemo/
│   │   ├── Scenes/
│   │   ├── Prefabs/
│   │   ├── Scripts/
├── Documentation/
│   ├── 设计文档.md
│   ├── QuickStart.md
│   ├── API.md
├── package.json
├── README.md
```

### 3.2 包元数据
- `name`: `com.ugc.dropview`
- `displayName`: `UGC.Dropview`
- `unity`: `2021.3`
- `dependencies`: `{ "com.unity.ugui": "1.0.0" }`
- `samples`: `BasicDropviewDemo`

## 4. 总体架构

### 4.1 模块划分
```
Dropview (主组件)
├── Trigger                 (触发器：启动打开/关闭)
├── ContentHost             (内容宿主：UGUI 容器或 UI Toolkit 宿主)
├── SelectionController     (选择控制器：单选/多选/无选择)
├── ItemListController      (列表控制：滚动/渲染/复用/虚拟化)
├── AnimatorController      (动画控制：展开/收起编排)
├── LayoutController        (布局控制：锚定/翻转/边界检测)
├── ContentBuilder          (内容构建器：代码动态生成)
├── EventBus                (事件派发：生命周期与交互)
└── Pool                    (对象池：项/容器复用，选配)
```

### 4.2 选择模式与状态机
- 模式：`None`/`Single`/`Multiple`
- 主状态：`Closed` → `Opening` → `Open` → `Closing` → `Closed`
- 并发与竞态处理：在 `Opening/Closing` 阶段序列化动画请求；必要时打断并过渡

## 5. 数据模型与接口

### 5.1 数据模型
```csharp
public enum SelectionMode { None, Single, Multiple }

public class DropItemData {
    public string id;
    public string text;
    public Sprite icon;
    public bool isEnabled = true;
    public bool isSelected = false;
    public object payload;
}

public class DropviewData {
    public IList<DropItemData> items;
    public SelectionMode selectionMode;
    public IList<string> preselectedIds;
    public int maxVisibleCount = 8;
    public bool autoCloseOnSelect = true;
    public bool closeOnOutsideClick = true;
}

public class PositioningConfig {
    public Vector2 edgePadding = new Vector2(8, 8);
    public bool flipOnOverflow = true;
    public bool matchTriggerWidth = true;
    public Direction[] preferredDirections = { Direction.Down, Direction.Up, Direction.Right, Direction.Left };
}

public class AnimationConfig {
    public float duration = 0.2f;
    public AnimationCurve curve = AnimationCurve.EaseInOut(0,0,1,1);
    public bool enableHeight = true;
    public bool enableFade = true;
    public bool enableScale = false;
}
```

### 5.2 渲染与构建接口
```csharp
public interface IDropItemRenderer {
    GameObject CreateItem(DropItemData data, Transform parent);
    void UpdateItem(GameObject item, DropItemData data);
}

public interface IDropviewContentBuilder {
    GameObject BuildContent(Transform parent, IList<DropItemData> items);
}

public interface ISelectionPolicy {
    bool CanSelect(IReadOnlyList<string> currentSelected, DropItemData target);
    int MaxSelectionCount { get; }
}
```

## 6. 交互流程

### 6.1 打开流程
1. 触发器调用 `Open(anchor)`（或 `Toggle`）
2. `LayoutController` 计算位置与尺寸（边缘检测与翻转）
3. `ContentHost` 构建并渲染内容（使用 `ContentBuilder` 与 `ItemRenderer`）
4. `AnimatorController` 播放展开动画
5. 派发事件 `OnOpened`

### 6.2 关闭流程
1. 外部点击/ESC/失焦/主动调用触发关闭
2. 播放收起动画
3. 回收内容（可选对象池）
4. 派发事件 `OnClosed`

### 6.3 选择流程
1. 点击项触发选择请求
2. `SelectionController` 按策略更新状态（单选/多选/限制）
3. 派发 `OnSelectionChanged`（包含选中集与差异）
4. 若 `Single` 且 `autoCloseOnSelect` 为真，自动关闭

## 7. 公共 API

### 7.1 属性
- `SelectionMode Mode { get; set; }`
- `bool IsOpen { get; }`
- `RectTransform Anchor { get; set; }`
- `AnimationConfig Animation { get; set; }`
- `PositioningConfig Positioning { get; set; }`
- `ISelectionPolicy SelectionPolicy { get; set; }`

### 7.2 方法
- `void Open(RectTransform anchor = null)`
- `void Close()`
- `void Toggle(RectTransform anchor = null)`
- `void SetItems(IList<DropItemData> items)`
- `IReadOnlyList<string> GetSelectedIds()`
- `void Select(string id, bool selected = true)`
- `void ClearSelection()`
- `void SetItemRenderer(IDropItemRenderer renderer)`
- `void SetContentBuilder(IDropviewContentBuilder builder)`

### 7.3 事件
- `event Action OnOpening`
- `event Action OnOpened`
- `event Action OnClosing`
- `event Action OnClosed`
- `event Action<DropItemData> OnItemClicked`
- `event Action<IReadOnlyList<string>> OnSelectionChanged`
- `event Action<Vector2> OnLayoutChanged`

## 8. 样式与资源
- 主题：背景/边框/阴影/圆角、选中/悬停/禁用态的颜色与字体
- 布局：内容宽度匹配触发器或自适应；最大高度与滚动；分组与分隔线
- 图标与文本：`Image`/`TMP_Text` 兼容；图文混排项模板
- 安全区与溢出：屏幕边缘翻转与留白；移动端安全区支持

## 9. 动画设计
- 类型：高度过渡、透明度、缩放、位移动画（可组合）
- 曲线与时长：每类动画独立配置
- 编排：展开时先定位与渲染，再并行动画；收起时先动画后回收
- 性能：动画期间尽量仅改 `CanvasGroup.alpha`、`RectTransform.sizeDelta`，避免频繁布局重建

## 10. 性能与内存
- 对象池：项与容器复用，降低 GC 与实例化开销
- 大数据项：可选虚拟化（仅渲染可见项），结合 `ScrollRect` 视口裁剪
- 事件去抖：高频滚动或输入事件节流/去抖
- 资源共享：样式资源与模板缓存；图标表复用

## 11. 可测试性
- 单元测试：选择策略（单选/多选、最大数、必选项、排他组）
- 状态机测试：`Open/Close/Toggle` 的边界与竞态
- 布局测试：锚定位置翻转、边缘溢出、窗口尺寸变化
- 事件测试：选择变更与生命周期事件的顺序与参数
- PlayMode 示例：基础使用、复杂内容、虚拟化大列表

## 12. 编辑器支持
- Inspector
  - 模式切换、样式预览、动画/布局参数
  - 统计与性能提示：项数、池大小、虚拟化状态
- 工具
  - `Auto Setup` 自动构建基础层级（Canvas/Viewport/Content）
  - `Generate Sample Items` 快速填充样例数据
  - `Preview Animation` 预览展开/收起动画
- 参考工程的识别与绑定风格：UGF.GameFramework.UI/Editor/Tools/UIDesignerContextMenu.cs:223、UGF.GameFramework.UI/Runtime/Core/UIExtensions.cs:210

## 13. 集成示例
- 基础下拉选择（单选）
  - 触发器按钮 + 文本标签；`Mode=Single`；选择后自动关闭
- 多选标签筛选
  - 项含复选框与计数；`Mode=Multiple`；顶部显示已选计数
- 非选择内容开关
  - `Mode=None`；内容为自定义面板（如颜色选择器、时间选择器）
- 上下文菜单
  - 图标 + 文本 + 快捷键提示；点击外部关闭

## 14. 配置项
- `selectionMode`、`autoCloseOnSelect`、`closeOnOutsideClick`
- `preferredDirections`（Down→Up→Right→Left）、`flipOnOverflow`
- `matchTriggerWidth`、`maxHeight`、`edgePadding`
- `animation.duration`、`animation.curve`、`animation.type`
- `virtualization.enabled`、`pool.initialSize`
- `input.keyboardNavigation`、`input.closeOnEsc`

## 15. 可访问性与本地化
- 文本本地化接口（集成项目已有本地化层）
- 键盘导航与焦点环；高对比模式样式
- 屏幕阅读器兼容（为项提供可描述文本）

## 16. 版本与依赖
- Unity 版本：`2021.3+`
- 依赖：`com.unity.ugui`；可选 `TextMeshPro`
- 程序集：`UGC.Dropview`（Runtime）、`UGC.Dropview.Editor`（Editor）

## 17. 风险与权衡
- 叠层管理：与其他弹层/模态层级协调（`Canvas` 排序）
- 事件穿透：内容与触发器的射线检测屏蔽
- 移动端：小屏溢出与翻转策略、手势滚动与关闭冲突处理
- 性能：动画与布局的重算；通过池化与最小化重绘降低成本
- UI Toolkit：次优先支持，先实现 UGUI 完整版本，再封装适配层

## 18. 开发计划
- M1 基础骨架：`Dropview`、`Open/Close/Toggle`、锚定与最小动画
- M2 选择模式：`SelectionController` 单选/多选与事件
- M3 列表容器：项渲染器、滚动与对象池
- M4 内容构建器：`IDropviewContentBuilder` 与自定义内容注入
- M5 编辑器与工具：Inspector、Auto Setup、预览
- M6 示例与文档：`BasicDropviewDemo`、快速入门与 API
- M7 UI Toolkit 适配层（可选）

## 19. 与现有工程的风格兼容
- 事件绑定与识别对齐现有风格，参考：
  - UGF.GameFramework.UI/Runtime/Core/UIExtensions.cs:210
  - UGF.GameFramework.UI/Editor/Tools/UIDesignerContextMenu.cs:127
- 包与程序集命名风格参考：
  - UGC.CollapseScrollView/Runtime/UGC.CollapseScrollView.asmdef:1
- 文档与示例结构参考：
  - UGC.CollapseScrollView/Documentation/设计文档.md:1
  - UGC.CollapseScrollView/Samples/BasicAccordionDemo/Scripts/BasicAccordionSetup.cs:1

